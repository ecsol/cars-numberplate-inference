#!/usr/bin/env python3
"""
æŒ‡å®šæ—¥ã®è»Šä¸¡ç”»åƒæƒ…å ±ã‚’JSONå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

Usage:
    python export_daily_images.py                    # ä»Šæ—¥ã®ç”»åƒ
    python export_daily_images.py --date 2026-02-03  # ç‰¹å®šæ—¥
    python export_daily_images.py --days-ago 1       # æ˜¨æ—¥
    python export_daily_images.py --output result.json  # å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«æŒ‡å®š
    python export_daily_images.py --chatwork         # Chatworkã«ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡
"""

import argparse
import json
import os
import sys
from pathlib import Path
from datetime import datetime, timedelta
from collections import defaultdict

import psycopg2
import requests

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
SCRIPT_DIR = Path(__file__).parent
PROJECT_DIR = SCRIPT_DIR.parent
sys.path.insert(0, str(PROJECT_DIR))


def load_env_file():
    """ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿"""
    env_file = PROJECT_DIR / ".env"
    if env_file.exists():
        with open(env_file) as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith("#") and "=" in line:
                    key, value = line.split("=", 1)
                    if key not in os.environ:
                        os.environ[key] = value


load_env_file()

# ======================
# è¨­å®š
# ======================
DB_CONFIG = {
    "host": os.getenv("DB_HOST", ""),
    "database": os.getenv("DB_NAME", "cartrading"),
    "user": os.getenv("DB_USER", ""),
    "password": os.getenv("DB_PASSWORD", ""),
}

IMAGE_BASE_URL = os.getenv("IMAGE_BASE_URL", "https://www.autobacs-cars-system.com")

# Chatworkè¨­å®š
CHATWORK_API_KEY = os.getenv("CHATWORK_API_KEY", "")
CHATWORK_ROOM_ID = os.getenv("CHATWORK_ROOM_ID", "")


def send_file_to_chatwork(file_path: str, message: str = "") -> bool:
    """
    Chatworkã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    
    Args:
        file_path: é€ä¿¡ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
        message: æ·»ä»˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    
    Returns:
        bool: æˆåŠŸã—ãŸã‚‰True
    """
    if not CHATWORK_API_KEY or not CHATWORK_ROOM_ID:
        print("[WARN] CHATWORK_API_KEY ã¾ãŸã¯ CHATWORK_ROOM_ID ãŒæœªè¨­å®š")
        return False
    
    url = f"https://api.chatwork.com/v2/rooms/{CHATWORK_ROOM_ID}/files"
    headers = {"X-ChatWorkToken": CHATWORK_API_KEY}
    
    try:
        with open(file_path, "rb") as f:
            files = {"file": (os.path.basename(file_path), f, "application/json")}
            data = {"message": message} if message else {}
            
            response = requests.post(url, headers=headers, files=files, data=data)
            
            if response.status_code == 200:
                print(f"[OK] Chatworkã«ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡å®Œäº†: {os.path.basename(file_path)}")
                return True
            else:
                print(f"[ERROR] Chatworké€ä¿¡å¤±æ•—: {response.status_code} - {response.text}")
                return False
    except Exception as e:
        print(f"[ERROR] Chatworké€ä¿¡ã‚¨ãƒ©ãƒ¼: {e}")
        return False


def get_images_by_date(target_date) -> list:
    """
    æŒ‡å®šæ—¥ã«ä½œæˆ/æ›´æ–°ã•ã‚ŒãŸç”»åƒã‚’å–å¾—

    Returns:
        list: [(id, car_cd, inspresultdata_cd, branch_no, save_file_name, created, modified), ...]
    """
    query = """
        SELECT 
            id,
            car_cd,
            inspresultdata_cd,
            branch_no,
            save_file_name,
            created,
            modified
        FROM upload_files
        WHERE (DATE(created) = %s OR DATE(modified) = %s)
          AND delete_flg = 0
          AND save_file_name IS NOT NULL
          AND save_file_name != ''
        ORDER BY 
            COALESCE(inspresultdata_cd, car_cd::text),
            branch_no ASC
    """
    params = (target_date, target_date)

    try:
        print(f"[INFO] DBæ¥ç¶š: {DB_CONFIG['host']}")
        conn = psycopg2.connect(**DB_CONFIG)
        cur = conn.cursor()
        cur.execute(query, params)
        rows = cur.fetchall()
        cur.close()
        conn.close()
        print(f"[INFO] DBå–å¾—å®Œäº†: {len(rows)}ä»¶")
        return rows
    except Exception as e:
        print(f"[ERROR] DBæ¥ç¶šå¤±æ•—: {e}")
        return []


def build_car_structure(images: list, target_date) -> dict:
    """
    ç”»åƒãƒªã‚¹ãƒˆã‚’è»Šä¸¡ã”ã¨ã®æ§‹é€ ã«å¤‰æ›

    Returns:
        dict: {
            "date": "2026-02-03",
            "total_cars": 10,
            "total_images": 100,
            "cars": {
                "car_id": {
                    "car_cd": "12345678",
                    "inspresultdata_cd": "1554913G",
                    "total_images": 6,
                    "images": [
                        {"branch_no": 1, "path": "/upfile/...", "url": "https://...", "filename": "..."},
                        ...
                    ]
                },
                ...
            }
        }
    """
    cars = defaultdict(
        lambda: {
            "car_cd": None,
            "inspresultdata_cd": None,
            "created": None,
            "modified": None,
            "total_images": 0,
            "images": [],
        }
    )

    for row in images:
        (
            file_id,
            car_cd,
            inspresultdata_cd,
            branch_no,
            save_file_name,
            created,
            modified,
        ) = row

        # car_keyã‚’æ±ºå®š
        car_key = inspresultdata_cd if inspresultdata_cd else str(car_cd)

        # ç”»åƒæƒ…å ±ã‚’è¿½åŠ 
        cars[car_key]["car_cd"] = str(car_cd) if car_cd else None
        cars[car_key]["inspresultdata_cd"] = inspresultdata_cd
        cars[car_key]["total_images"] += 1

        # è»Šä¸¡ã®ä½œæˆæ—¥ãƒ»æ›´æ–°æ—¥ã‚’è¿½è·¡ï¼ˆæœ€ã‚‚å¤ã„createdã€æœ€ã‚‚æ–°ã—ã„modifiedï¼‰
        if created:
            created_str = (
                created.isoformat() if hasattr(created, "isoformat") else str(created)
            )
            if (
                cars[car_key]["created"] is None
                or created_str < cars[car_key]["created"]
            ):
                cars[car_key]["created"] = created_str
        if modified:
            modified_str = (
                modified.isoformat()
                if hasattr(modified, "isoformat")
                else str(modified)
            )
            if (
                cars[car_key]["modified"] is None
                or modified_str > cars[car_key]["modified"]
            ):
                cars[car_key]["modified"] = modified_str

        cars[car_key]["images"].append(
            {
                "branch_no": branch_no,
                "path": save_file_name,
                "url": f"{IMAGE_BASE_URL}{save_file_name}",
                "filename": os.path.basename(save_file_name),
                "file_id": file_id,
                "created": (
                    created.isoformat()
                    if created and hasattr(created, "isoformat")
                    else str(created) if created else None
                ),
                "modified": (
                    modified.isoformat()
                    if modified and hasattr(modified, "isoformat")
                    else str(modified) if modified else None
                ),
            }
        )

    # branch_noã§ã‚½ãƒ¼ãƒˆ
    for car_key in cars:
        cars[car_key]["images"].sort(key=lambda x: x["branch_no"] or 999)

    return {
        "date": str(target_date),
        "exported_at": datetime.now().isoformat(),
        "total_cars": len(cars),
        "total_images": len(images),
        "image_base_url": IMAGE_BASE_URL,
        "cars": dict(cars),
    }


def main():
    parser = argparse.ArgumentParser(
        description="æŒ‡å®šæ—¥ã®è»Šä¸¡ç”»åƒæƒ…å ±ã‚’JSONå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ä½¿ç”¨ä¾‹:
  python export_daily_images.py                    # ä»Šæ—¥ã®ç”»åƒ
  python export_daily_images.py --date 2026-02-03  # ç‰¹å®šæ—¥
  python export_daily_images.py --days-ago 1       # æ˜¨æ—¥
  python export_daily_images.py --output result.json  # å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«æŒ‡å®š
        """,
    )
    parser.add_argument(
        "--days-ago",
        type=int,
        default=0,
        help="ä½•æ—¥å‰ã®ç”»åƒã‚’å–å¾—ã™ã‚‹ã‹ (0=ä»Šæ—¥, 1=æ˜¨æ—¥, ...) [ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0]",
    )
    parser.add_argument(
        "--date",
        type=str,
        default=None,
        help="å¯¾è±¡æ—¥ã‚’æŒ‡å®š (YYYY-MM-DDå½¢å¼ã€--days-agoã‚ˆã‚Šå„ªå…ˆ)",
    )
    parser.add_argument(
        "--output",
        "-o",
        type=str,
        default=None,
        help="å‡ºåŠ›JSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ (æœªæŒ‡å®š: images_YYYYMMDD.json)",
    )
    parser.add_argument(
        "--car-id",
        type=str,
        default=None,
        help="ç‰¹å®šã®è»Šä¸¡IDã®ã¿å‡ºåŠ›",
    )
    parser.add_argument(
        "--chatwork",
        action="store_true",
        help="Chatworkã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€ä¿¡",
    )

    args = parser.parse_args()

    # å¯¾è±¡æ—¥ã‚’è¨ˆç®—
    if args.date:
        try:
            target_date = datetime.strptime(args.date, "%Y-%m-%d").date()
        except ValueError:
            print(f"[ERROR] æ—¥ä»˜å½¢å¼ãŒä¸æ­£: {args.date} (YYYY-MM-DDå½¢å¼ã§æŒ‡å®š)")
            return 1
    else:
        target_date = datetime.now().date() - timedelta(days=args.days_ago)

    # å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å
    if args.output:
        output_file = args.output
    else:
        output_file = f"images_{target_date.strftime('%Y%m%d')}.json"

    print("=" * 60)
    print(f"è»Šä¸¡ç”»åƒã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ")
    print(f"  å¯¾è±¡æ—¥: {target_date}")
    print(f"  å‡ºåŠ›å…ˆ: {output_file}")
    if args.car_id:
        print(f"  è»Šä¸¡ID: {args.car_id}")
    print("=" * 60)

    # ç”»åƒã‚’å–å¾—
    images = get_images_by_date(target_date)

    if not images:
        print(f"[INFO] {target_date} ã®ç”»åƒã¯ã‚ã‚Šã¾ã›ã‚“")
        return 0

    # æ§‹é€ åŒ–
    result = build_car_structure(images, target_date)

    # ç‰¹å®šè»Šä¸¡ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
    if args.car_id:
        if args.car_id in result["cars"]:
            filtered_car = result["cars"][args.car_id]
            result["cars"] = {args.car_id: filtered_car}
            result["total_cars"] = 1
            result["total_images"] = filtered_car["total_images"]
        else:
            print(f"[ERROR] è»Šä¸¡ID '{args.car_id}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
            return 1

    # JSONå‡ºåŠ›
    with open(output_file, "w", encoding="utf-8") as f:
        json.dump(result, f, ensure_ascii=False, indent=2)

    print("=" * 60)
    print(f"[OK] ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†")
    print(f"  è»Šä¸¡æ•°: {result['total_cars']}å°")
    print(f"  ç”»åƒæ•°: {result['total_images']}æš")
    print(f"  å‡ºåŠ›å…ˆ: {output_file}")
    print("=" * 60)

    # ã‚µãƒãƒªãƒ¼è¡¨ç¤º
    print("\n[è»Šä¸¡ä¸€è¦§]")
    for car_id, car_info in list(result["cars"].items())[:20]:
        print(f"  {car_id}: {car_info['total_images']}æš")
    if len(result["cars"]) > 20:
        print(f"  ... ä»– {len(result['cars']) - 20}å°")

    # Chatworkã«ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡
    if args.chatwork:
        message = f"ğŸ“Š è»Šä¸¡ç”»åƒã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ({target_date})\nè»Šä¸¡æ•°: {result['total_cars']}å° / ç”»åƒæ•°: {result['total_images']}æš"
        send_file_to_chatwork(output_file, message)

    return 0


if __name__ == "__main__":
    sys.exit(main())
